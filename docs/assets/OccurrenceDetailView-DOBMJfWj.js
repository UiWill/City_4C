import{d as te,E as se,a as d,y as ae,c as i,f as u,b as e,t as o,j as _,C as oe,g as S,s as z,e as le,w as ne,v as ie,F as B,z as T,n as F,B as v,p as r,_ as re}from"./index-BZ6IL2aC.js";import{f as de,p as ue}from"./pt-BR-BZBxiJ23.js";const ce={class:"occurrence-detail"},ve={key:0,class:"loading-state"},pe={key:1,class:"error-state"},me={key:2,class:"occurrence-content"},_e={class:"occurrence-header"},ge={class:"header-main"},fe={class:"header-info"},ye={class:"header-meta"},be={class:"occurrence-id"},he={class:"occurrence-date"},we={class:"header-actions"},Ce={class:"status-controls"},Se={class:"priority-controls"},Ve={class:"main-content"},ke={class:"left-column"},Ae={class:"video-section"},Ee={class:"video-container"},Oe=["src"],xe={key:0,class:"video-error"},De={class:"error-actions"},ze={key:0,class:"technical-info"},Me={class:"video-info"},Le={class:"video-meta"},Re={class:"video-duration"},Ue={class:"video-filename"},$e={key:0,class:"description-section"},Pe={class:"description-content"},He={class:"updates-section"},Ie={class:"add-comment"},Be=["disabled"],Te={key:0,class:"updates-list"},Fe={class:"update-header"},Ne={class:"update-author"},je={class:"author-avatar"},qe={class:"author-info"},Ze={class:"author-name"},Ge={class:"update-date"},Ye={key:0,class:"status-change"},Je={class:"update-content"},Ke={key:1,class:"no-updates"},Qe={class:"right-column"},We={class:"location-section"},Xe={class:"location-content"},et={class:"map-placeholder"},tt={class:"map-content"},st={class:"location-details"},at={class:"detail-item"},ot={class:"value coordinates"},lt={key:0,class:"detail-item"},nt={class:"value"},it={key:1,class:"detail-item"},rt={class:"value"},dt={class:"reporter-section"},ut={class:"reporter-content"},ct={class:"reporter-info"},vt={class:"reporter-details"},pt={class:"detail-item"},mt={class:"value"},_t={class:"detail-item"},gt={class:"value"},ft={key:0,class:"detail-item"},yt={class:"value"},bt={class:"assignment-section"},ht={class:"assignment-content"},wt=["value"],Ct={key:0,class:"assigned-info"},St={class:"agent-info"},Vt={class:"agent-avatar"},kt={class:"agent-details"},At={class:"agent-name"},Et={class:"agent-role"},Ot={key:0,class:"service-order-section"},xt={class:"service-order-content"},Dt={class:"os-header"},zt={class:"protocol-number"},Mt={class:"value protocol"},Lt={class:"os-details"},Rt={class:"detail-item"},Ut={class:"value"},$t={key:0,class:"detail-item"},Pt={class:"value"},Ht={key:1,class:"detail-item"},It={key:2,class:"detail-item"},Bt={class:"value"},Tt={class:"detail-item"},Ft={class:"value"},Nt={key:3,class:"detail-item"},jt={class:"value"},qt={class:"os-actions"},Zt=["disabled"],Gt={class:"metadata-section"},Yt={class:"metadata-content"},Jt={class:"detail-item"},Kt={class:"value"},Qt={class:"detail-item"},Wt={class:"value"},Xt={key:0,class:"detail-item"},es={class:"value"},ts={key:1,class:"detail-item"},ss={class:"value"},as=te({__name:"OccurrenceDetailView",setup(os){const g=se().params.id,a=d(null),M=d([]),$=d([]),l=d(null),L=d(!1),V=d(""),k=d(!1),y=d(""),P=d(""),A=d(!1),b=d("pending"),E=d(1),O=d(""),h=d("created"),w=d(),p=d(!1),x=d(!1),f=d({filename:"",size:0,status:"N√£o verificado"}),D=async()=>{L.value=!0,V.value="";try{const s=await v.getOccurrenceById(g);if(a.value=s,b.value=s.status,E.value=s.priority,O.value=s.assigned_to||"",s.video_filename||s.video_url)try{let t=s.video_filename;if(!t&&s.video_url){const C=s.video_url.split("/");t=C[C.length-1]}const m=await v.findVideoFile(t)||t;console.log("Attempting to load video:",m);const I=await v.getVideoSignedUrl(m);if(f.value.filename=m,f.value.status="Arquivo encontrado e URL gerada",m.includes(".dat")){console.log("Detected encrypted file, will show error with technical details"),p.value=!0,f.value.status="Arquivo criptografado detectado";try{const C=await fetch(I,{method:"HEAD"});f.value.size=parseInt(C.headers.get("content-length")||"0")}catch{console.log("Could not get file size")}a.value&&(a.value.video_url="https://sample-videos.com/zip/10/mp4/720/SampleVideo_720x480_1mb.mp4")}else a.value&&(a.value.video_url=I,p.value=!1)}catch{console.log("Video loading failed completely, using demo video"),p.value=!0,a.value&&(a.value.video_url="https://sample-videos.com/zip/10/mp4/720/SampleVideo_720x480_1mb.mp4")}else console.log("No video information available, using demo"),p.value=!0,a.value&&(a.value.video_url="https://sample-videos.com/zip/10/mp4/720/SampleVideo_720x480_1mb.mp4")}catch(s){V.value=s.message||"Erro ao carregar ocorr√™ncia"}finally{L.value=!1}},R=async()=>{try{M.value=await v.getOccurrenceUpdates(g)}catch(s){console.error("Error loading updates:",s)}},N=async()=>{try{$.value=await v.getAgents()}catch(s){console.error("Error loading agents:",s)}},U=async()=>{try{const s=await v.getServiceOrderByOccurrenceId(g);l.value=s,s&&(h.value=s.status)}catch(s){console.error("Error loading service order:",s)}},j=async()=>{try{await v.updateOccurrenceStatus(g,b.value),await D(),await R(),await U()}catch(s){console.error("Error updating status:",s)}},q=async()=>{try{await v.updateOccurrencePriority(g,E.value),await D()}catch(s){console.error("Error updating priority:",s)}},Z=async()=>{try{await v.updateOccurrenceStatus(g,b.value,O.value),await D()}catch(s){console.error("Error updating assignment:",s)}},G=async()=>{if(y.value.trim()){k.value=!0;try{await v.addOccurrenceUpdate(g,y.value.trim()),y.value="",await R()}catch(s){console.error("Error adding comment:",s)}finally{k.value=!1}}},Y=()=>{w.value&&(P.value=Math.round(w.value.duration).toString(),p.value=!1)},J=()=>{p.value=!0,console.log("Video loading error - this is expected for demo purposes")},K=()=>{a.value&&(a.value.video_url="https://sample-videos.com/zip/10/mp4/720/SampleVideo_720x480_1mb.mp4",p.value=!1,w.value&&w.value.load())},c=s=>de(new Date(s),"dd/MM/yyyy HH:mm",{locale:ue}),Q=async()=>{if(l.value)try{const s=h.value==="completed"?new Date().toISOString():void 0;await v.updateServiceOrderStatus(l.value.id,h.value,s),await U()}catch(s){console.error("Error updating service order status:",s)}},W=async()=>{if(l.value){A.value=!0;try{const s=`
ORDEM DE SERVI√áO - ${l.value.protocol_number}

T√≠tulo: ${l.value.title}
Status: ${H(l.value.status)}
Prioridade: ${l.value.priority}/5
${l.value.due_date?`Data Limite: ${c(l.value.due_date)}`:""}

Descri√ß√£o:
${l.value.description}

${l.value.assigned_agent?`Respons√°vel: ${l.value.assigned_agent.full_name}`:""}

Criada em: ${c(l.value.created_at)}
${l.value.completed_at?`Conclu√≠da em: ${c(l.value.completed_at)}`:""}

Sistema CITY 4C - Gerado automaticamente
    `.trim(),t=new Blob([s],{type:"text/plain"}),n=window.URL.createObjectURL(t),m=document.createElement("a");m.href=n,m.download=`OS_${l.value.protocol_number}.txt`,m.click(),window.URL.revokeObjectURL(n)}catch(s){console.error("Error exporting service order:",s)}finally{A.value=!1}}},X=s=>new Date(s)<new Date,H=s=>({created:"Criada",in_progress:"Em Andamento",completed:"Conclu√≠da",cancelled:"Cancelada"})[s]||s,ee=s=>({pending:"Pendente",in_progress:"Em Andamento",resolved:"Resolvido",rejected:"Rejeitado"})[s]||s;return ae(()=>{D(),R(),N(),U()}),(s,t)=>(r(),i("div",ce,[L.value?(r(),i("div",ve,t[8]||(t[8]=[e("div",{class:"spinner"},null,-1),e("p",null,"Carregando detalhes da ocorr√™ncia...",-1)]))):V.value?(r(),i("div",pe,[t[9]||(t[9]=e("div",{class:"error-icon"},"‚ö†Ô∏è",-1)),t[10]||(t[10]=e("h3",null,"Erro ao carregar ocorr√™ncia",-1)),e("p",null,o(V.value),1),e("button",{onClick:t[0]||(t[0]=n=>s.$router.go(-1)),class:"btn btn-secondary"}," Voltar ")])):a.value?(r(),i("div",me,[e("div",_e,[e("div",ge,[e("button",{onClick:t[1]||(t[1]=n=>s.$router.go(-1)),class:"back-button"},t[11]||(t[11]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1),_(" Voltar ",-1)])),e("div",fe,[e("h1",null,o(a.value.title||"Ocorr√™ncia sem t√≠tulo"),1),e("div",ye,[a.value.tags?(r(),i("span",{key:0,class:"occurrence-tag",style:oe({backgroundColor:a.value.tags.color+"20",color:a.value.tags.color})},o(a.value.tags.name),5)):u("",!0),e("span",be,"ID: "+o(a.value.id.substring(0,8))+"...",1),e("span",he,o(c(a.value.created_at)),1)])])]),e("div",we,[e("div",Ce,[t[13]||(t[13]=e("label",{for:"status-select",class:"control-label"},"Status:",-1)),S(e("select",{id:"status-select","onUpdate:modelValue":t[2]||(t[2]=n=>b.value=n),onChange:j,class:"form-select"},t[12]||(t[12]=[e("option",{value:"pending"},"Pendente",-1),e("option",{value:"in_progress"},"Em Andamento",-1),e("option",{value:"resolved"},"Resolvido",-1),e("option",{value:"rejected"},"Rejeitado",-1)]),544),[[z,b.value]])]),e("div",Se,[t[15]||(t[15]=e("label",{for:"priority-select",class:"control-label"},"Prioridade:",-1)),S(e("select",{id:"priority-select","onUpdate:modelValue":t[3]||(t[3]=n=>E.value=n),onChange:q,class:"form-select"},t[14]||(t[14]=[le('<option value="1" data-v-34e04ef9>M√≠nima</option><option value="2" data-v-34e04ef9>Baixa</option><option value="3" data-v-34e04ef9>M√©dia</option><option value="4" data-v-34e04ef9>Alta</option><option value="5" data-v-34e04ef9>Cr√≠tica</option>',5)]),544),[[z,E.value]])])])]),e("div",Ve,[e("div",ke,[e("div",Ae,[t[24]||(t[24]=e("h2",null,"V√≠deo da Ocorr√™ncia",-1)),e("div",Ee,[e("video",{ref_key:"videoPlayer",ref:w,src:a.value.video_url,controls:"",preload:"metadata",class:"video-player",onLoadedmetadata:Y,onError:J}," Seu navegador n√£o suporta o elemento de v√≠deo. ",40,Oe),p.value?(r(),i("div",xe,[t[22]||(t[22]=e("p",null,"üîí V√≠deo Protegido por Criptografia",-1)),t[23]||(t[23]=e("p",{class:"error-details"},"Este v√≠deo foi criptografado pelo aplicativo m√≥vel para seguran√ßa. O sistema web atual n√£o tem as chaves de descriptografia. Carregando v√≠deo de demonstra√ß√£o...",-1)),e("div",De,[e("button",{onClick:K,class:"btn btn-primary"},"üé¨ Assistir V√≠deo Demo"),e("button",{onClick:t[4]||(t[4]=n=>x.value=!x.value),class:"btn btn-secondary"},o(x.value?"Ocultar":"Ver")+" Detalhes T√©cnicos ",1)]),x.value?(r(),i("div",ze,[t[20]||(t[20]=e("h4",null,"Informa√ß√µes T√©cnicas:",-1)),e("ul",null,[e("li",null,[t[16]||(t[16]=e("strong",null,"Arquivo encontrado:",-1)),_(" ‚úÖ Sim ("+o(f.value.filename)+")",1)]),e("li",null,[t[17]||(t[17]=e("strong",null,"Tamanho:",-1)),_(" "+o(f.value.size)+" bytes",1)]),t[19]||(t[19]=e("li",null,[e("strong",null,"Formato:"),_(" .dat (criptografado)")],-1)),e("li",null,[t[18]||(t[18]=e("strong",null,"Status:",-1)),_(" "+o(f.value.status),1)])]),t[21]||(t[21]=e("p",{class:"tech-note"}," üí° Para reproduzir este v√≠deo, seria necess√°rio implementar a descriptografia no frontend ou ter uma API que descriptografe os arquivos. ",-1))])):u("",!0)])):u("",!0),e("div",Me,[e("div",Le,[e("span",Re," Dura√ß√£o: "+o(a.value.video_duration||P.value)+"s ",1),e("span",Ue," Arquivo: "+o(a.value.video_filename),1)])])])]),a.value.description?(r(),i("div",$e,[t[25]||(t[25]=e("h2",null,"Descri√ß√£o",-1)),e("div",Pe,[e("p",null,o(a.value.description),1)])])):u("",!0),e("div",He,[t[28]||(t[28]=e("h2",null,"Atualiza√ß√µes",-1)),e("div",Ie,[e("form",{onSubmit:ne(G,["prevent"]),class:"comment-form"},[S(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=n=>y.value=n),placeholder:"Adicione uma atualiza√ß√£o ou coment√°rio...",class:"form-textarea",rows:"3",required:""},null,512),[[ie,y.value]]),e("button",{type:"submit",class:"btn btn-primary",disabled:!y.value.trim()||k.value},o(k.value?"Adicionando...":"Adicionar Coment√°rio"),9,Be)],32)]),M.value.length>0?(r(),i("div",Te,[(r(!0),i(B,null,T(M.value,n=>(r(),i("div",{key:n.id,class:"update-item"},[e("div",Fe,[e("div",Ne,[e("div",je,o(n.profiles?.full_name?.[0]||"U"),1),e("div",qe,[e("span",Ze,o(n.profiles?.full_name||"Usu√°rio"),1),e("span",Ge,o(c(n.created_at)),1)])]),n.status_change?(r(),i("div",Ye,[t[26]||(t[26]=_(" Status alterado para: ",-1)),e("strong",null,o(ee(n.status_change)),1)])):u("",!0)]),e("div",Je,[e("p",null,o(n.comment),1)])]))),128))])):(r(),i("div",Ke,t[27]||(t[27]=[e("p",null,"Nenhuma atualiza√ß√£o ainda. Seja o primeiro a comentar!",-1)])))])]),e("div",Qe,[e("div",We,[t[34]||(t[34]=e("h3",null,"Localiza√ß√£o",-1)),e("div",Xe,[e("div",et,[e("div",tt,[t[29]||(t[29]=e("svg",{class:"map-icon",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"})],-1)),t[30]||(t[30]=e("p",null,"Mapa Interativo",-1)),e("small",null,o(a.value.latitude.toFixed(6))+", "+o(a.value.longitude.toFixed(6)),1)])]),e("div",st,[e("div",at,[t[31]||(t[31]=e("span",{class:"label"},"Coordenadas:",-1)),e("span",ot,o(a.value.latitude.toFixed(6))+", "+o(a.value.longitude.toFixed(6)),1)]),a.value.address?(r(),i("div",lt,[t[32]||(t[32]=e("span",{class:"label"},"Endere√ßo:",-1)),e("span",nt,o(a.value.address),1)])):u("",!0),a.value.location_accuracy?(r(),i("div",it,[t[33]||(t[33]=e("span",{class:"label"},"Precis√£o:",-1)),e("span",rt,o(a.value.location_accuracy.toFixed(1))+"m",1)])):u("",!0)])])]),e("div",dt,[t[39]||(t[39]=e("h3",null,"Informa√ß√µes do Relator",-1)),e("div",ut,[e("div",ct,[t[38]||(t[38]=e("div",{class:"reporter-avatar"},[e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"})])],-1)),e("div",vt,[e("div",pt,[t[35]||(t[35]=e("span",{class:"label"},"Nome:",-1)),e("span",mt,o(a.value.profiles?.full_name||"An√¥nimo"),1)]),e("div",_t,[t[36]||(t[36]=e("span",{class:"label"},"Tipo:",-1)),e("span",gt,o(a.value.reporter_type==="agent"?"Agente P√∫blico":"Cidad√£o"),1)]),a.value.profiles?.department?(r(),i("div",ft,[t[37]||(t[37]=e("span",{class:"label"},"Departamento:",-1)),e("span",yt,o(a.value.profiles.department),1)])):u("",!0)])])])]),e("div",bt,[t[41]||(t[41]=e("h3",null,"Respons√°vel",-1)),e("div",ht,[S(e("select",{"onUpdate:modelValue":t[6]||(t[6]=n=>O.value=n),onChange:Z,class:"form-select"},[t[40]||(t[40]=e("option",{value:""},"N√£o atribu√≠do",-1)),(r(!0),i(B,null,T($.value,n=>(r(),i("option",{key:n.id,value:n.id},o(n.full_name||n.id),9,wt))),128))],544),[[z,O.value]]),a.value.assigned_agent?(r(),i("div",Ct,[e("div",St,[e("div",Vt,o(a.value.assigned_agent.full_name?.[0]||"A"),1),e("div",kt,[e("span",At,o(a.value.assigned_agent.full_name||"Agente"),1),e("span",Et,o(a.value.assigned_agent.department||a.value.assigned_agent.role),1)])])])):u("",!0)])]),l.value?(r(),i("div",Ot,[t[51]||(t[51]=e("h3",null,[e("svg",{viewBox:"0 0 24 24",fill:"currentColor",class:"section-icon"},[e("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})]),_(" Ordem de Servi√ßo ")],-1)),e("div",xt,[e("div",Dt,[e("div",zt,[t[42]||(t[42]=e("span",{class:"label"},"Protocolo:",-1)),e("span",Mt,o(l.value.protocol_number),1)]),e("div",{class:F(["os-status","os-status--"+l.value.status])},o(H(l.value.status)),3)]),e("div",Lt,[e("div",Rt,[t[43]||(t[43]=e("span",{class:"label"},"T√≠tulo:",-1)),e("span",Ut,o(l.value.title),1)]),l.value.estimated_duration_hours?(r(),i("div",$t,[t[44]||(t[44]=e("span",{class:"label"},"Prazo Estimado:",-1)),e("span",Pt,o(l.value.estimated_duration_hours)+"h",1)])):u("",!0),l.value.due_date?(r(),i("div",Ht,[t[45]||(t[45]=e("span",{class:"label"},"Data Limite:",-1)),e("span",{class:F(["value due-date",{overdue:X(l.value.due_date)}])},o(c(l.value.due_date)),3)])):u("",!0),l.value.assigned_agent?(r(),i("div",It,[t[46]||(t[46]=e("span",{class:"label"},"Respons√°vel:",-1)),e("span",Bt,o(l.value.assigned_agent.full_name),1)])):u("",!0),e("div",Tt,[t[47]||(t[47]=e("span",{class:"label"},"Criada em:",-1)),e("span",Ft,o(c(l.value.created_at)),1)]),l.value.completed_at?(r(),i("div",Nt,[t[48]||(t[48]=e("span",{class:"label"},"Conclu√≠da em:",-1)),e("span",jt,o(c(l.value.completed_at)),1)])):u("",!0)]),e("div",qt,[S(e("select",{"onUpdate:modelValue":t[7]||(t[7]=n=>h.value=n),onChange:Q,class:"form-select"},t[49]||(t[49]=[e("option",{value:"created"},"Criada",-1),e("option",{value:"in_progress"},"Em Andamento",-1),e("option",{value:"completed"},"Conclu√≠da",-1),e("option",{value:"cancelled"},"Cancelada",-1)]),544),[[z,h.value]]),e("button",{onClick:W,class:"btn btn-secondary btn-sm",disabled:A.value},[t[50]||(t[50]=e("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1)),_(" "+o(A.value?"Exportando...":"Exportar OS"),1)],8,Zt)])])])):u("",!0),e("div",Gt,[t[56]||(t[56]=e("h3",null,"Metadados",-1)),e("div",Yt,[e("div",Jt,[t[52]||(t[52]=e("span",{class:"label"},"Criado em:",-1)),e("span",Kt,o(c(a.value.created_at)),1)]),e("div",Qt,[t[53]||(t[53]=e("span",{class:"label"},"Atualizado em:",-1)),e("span",Wt,o(c(a.value.updated_at)),1)]),a.value.resolved_at?(r(),i("div",Xt,[t[54]||(t[54]=e("span",{class:"label"},"Resolvido em:",-1)),e("span",es,o(c(a.value.resolved_at)),1)])):u("",!0),a.value.metadata?(r(),i("div",ts,[t[55]||(t[55]=e("span",{class:"label"},"Dispositivo:",-1)),e("span",ss,o(a.value.metadata.device_info?.platform||"N/A"),1)])):u("",!0)])])])])])):u("",!0)]))}}),rs=re(as,[["__scopeId","data-v-34e04ef9"]]);export{rs as default};
